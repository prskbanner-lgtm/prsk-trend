<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube 再生数ランキング & トレンド ダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg: #ffffff;
      --card: #ffffff;
      --muted: #596274;
      --text: #111827;
      --accent:#2563eb;
      --glass: rgba(15,23,42,0.03);
      --card-radius:12px;
      font-family: Inter, system-ui, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      color: var(--text);
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text);}
    .wrap{max-width:1200px;margin:28px auto;padding:20px;}
    header{display:flex;gap:18px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    header .title{font-size:20px;color:var(--text); font-weight:700;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .card{
      background:var(--card);
      border-radius:var(--card-radius);
      padding:14px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      border: 1px solid rgba(15,23,42,0.04);
    }
    .grid{display:grid;grid-template-columns: 240px 1fr 240px;gap:16px;}
    select, button, input[type="search"]{
      background:#f7f9fb; border:1px solid rgba(15,23,42,0.06); color:var(--text); padding:8px 10px;border-radius:8px;
      font-size:13px;
    }
    select:focus, input[type="search"]:focus, button:focus{ outline: 2px solid rgba(37,99,235,0.12); outline-offset:2px; }
    button.primary{background:linear-gradient(90deg,#3b82f6,#60a5fa); color:#fff; font-weight:700; border:none; padding:9px 12px;}
    .rank-list{display:flex;flex-direction:column;gap:8px; max-height:520px; overflow:auto; padding-right:6px;}
    /* ----- ランキング項目を全体的に小さくして収める ----- */
    .video-item{
      display:flex;
      gap:8px;                   /* 間隔を小さく */
      align-items:flex-start;
      padding:8px;               /* 内側の余白を小さく */
      border-radius:8px;
      cursor:pointer;
      transition:background .12s, transform .06s;
      border: 1px solid rgba(15,23,42,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.0));
      min-height: 64px;         /* 高さの下限を抑える */
    }
    .video-item:hover{background:rgba(37,99,235,0.03); transform: translateY(-2px);}
    .rank-num{
      width:28px;               /* 小さく */
      min-width:28px;
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:var(--accent);
      font-weight:800;
      border-radius:6px;
      border:1px solid rgba(37,99,235,0.12);
      background:#fff;
      flex-shrink:0;
    }
    /* サムネイルを小さめに */
    .thumb{
      width:120px;              /* 小さめにして収める */
      height:72px;
      border-radius:6px;
      background:#eee;
      flex:0 0 120px;
      object-fit:cover;
      border:1px solid rgba(15,23,42,0.04);
    }
    .meta{flex:1;min-width:0;display:flex;flex-direction:column;gap:6px;}
    .meta .title{font-size:13px;color:var(--text);font-weight:700;line-height:1.15;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .meta .sub{font-size:11px;color:var(--muted);display:flex;gap:8px;align-items:center;}
    .badge{padding:3px 7px;border-radius:8px;font-size:11px;background:#f1f5f9;color:var(--muted);border:1px solid rgba(15,23,42,0.03)}
    .stats-row{display:flex;gap:8px;align-items:center; justify-content:flex-end;}
    .big-card{padding:16px;}
    .chart-area{height:320px;}
    .tabs{display:flex;gap:8px;margin-bottom:12px;}
    .tabs button{background:transparent;border:1px solid rgba(15,23,42,0.04);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;}
    .tabs button.active{background:linear-gradient(90deg, rgba(37,99,235,0.08), rgba(37,99,235,0.04)); color:var(--text);border-color:transparent;}
    .top-metrics{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .metric{background:linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.01)); padding:10px;border-radius:10px; min-width:150px; border:1px solid rgba(15,23,42,0.04);}
    .metric .val{font-size:18px;color:var(--text);font-weight:700}
    .footer-note{font-size:12px;color:var(--muted);margin-top:8px}
    .trend-list{display:flex;flex-direction:column;gap:12px;}
    .trend-item{padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.04);background:linear-gradient(180deg, rgba(15,23,42,0.01), rgba(15,23,42,0.00));}
    .trend-item .label{font-size:13px;color:var(--muted);margin-bottom:6px;}
    .trend-item .val{font-weight:700;color:var(--text);}

    /* 再生回数を表示する横長ボックス */
    .view-bar{
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.04);
      padding:6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      font-size:13px;
      color:var(--text);
    }
    .view-bar .count{font-weight:800;}
    .view-bar .delta{font-size:12px;color:var(--muted);margin-left:10px}

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
      .thumb{width:100px; height:56px; flex:0 0 100px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">YouTube 再生数ランキング & トレンド</div>
        <div class="subtitle" style="font-size:13px;color:var(--muted); margin-top:6px;">
          <div id="lastUpdated" style="font-size:12px;color:var(--muted)">最終更新: 読み込み中...</div>
        </div>
      </div>
      <div class="controls">
        <input id="search" type="search" placeholder="タイトル / バナー / ユニット で検索">
        <select id="scope">
          <option value="all">全体</option>
          <option value="banner">バナー別</option>
          <option value="unit">ユニット別</option>
        </select>
        <select id="groupFilter"><option value="all">グループ: 全て</option></select>
        <button id="reload" class="primary">データを再読み込み</button>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <strong style="color:var(--text)">トレンド情報</strong>
          <div style="margin-top:10px" class="trend-list">
            <div class="trend-item">
              <div class="label">直近1週間で再生数伸びトップ</div>
              <div id="trendWeek" class="val">—</div>
            </div>
            <div class="trend-item">
              <div class="label">直近1ヶ月で再生数伸びトップ</div>
              <div id="trendMonth" class="val">—</div>
            </div>
            <div class="trend-item">
              <div class="label">累計再生数トップ</div>
              <div id="trendTotal" class="val">—</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card big-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div id="selectedTitle" style="font-weight:700;font-size:16px;color:var(--text)">（動画を選択してください）</div>
              <div id="selectedMeta" style="font-size:13px;color:var(--muted);margin-top:6px">—</div>
            </div>
            <div class="stats-row">
              <div style="text-align:right">
                <div style="font-size:12px;color:var(--muted)">最新再生数</div>
                <div id="selectedViews" style="font-weight:800;font-size:18px;color:var(--text)">—</div>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;" class="tabs">
            <button class="tab-mode active" data-period="all">全期間推移</button>
            <button class="tab-mode" data-period="30">直近30日</button>
            <button class="tab-mode" data-period="7">直近7日</button>
          </div>

          <div class="chart-area card" style="padding:12px;">
            <canvas id="trendChart" style="width:100%;height:320px"></canvas>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
            <div class="metric card" style="min-width:180px;">
              <div style="font-size:12px;color:var(--muted)">直近7日増分</div>
              <div id="viewDelta7" class="val">—</div>
            </div>
            <div class="metric card" style="min-width:180px;">
              <div style="font-size:12px;color:var(--muted)">直近30日増分</div>
              <div id="viewDelta30" class="val">—</div>
            </div>
            <div class="metric card" style="min-width:180px;">
              <div style="font-size:12px;color:var(--muted)">投稿日</div>
              <div id="publishDate" class="val">—</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong style="color:var(--text)">注記 / 操作</strong>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">
            ・ページの最終更新時刻は <code>data/videos.json</code> の <code>updated_at</code> を表示しています。<br>
            ・ワークフローが 30 分ごとに実行され、履歴は 30 分刻み（UTC）で保存されます。<br>
            ・初回はワークフローを手動実行して <code>data/videos.json</code> を作成してください。
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong style="color:var(--text)">ランキング</strong>
            <div style="font-size:13px;color:var(--muted)">並び替え:
              <select id="sortMode">
                <option value="total">累計再生数（降順）</option>
                <option value="week">直近7日増分（降順）</option>
                <option value="month">直近30日増分（降順）</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px;" class="rank-list card" id="rankList">
            読み込み中...
          </div>
          <div class="footer-note">※ サムネイルをクリックすると右側でグラフ表示します。データは <code>data/videos.json</code> から読み込まれます。</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* --- helper --- */
function fmt(n){ return n === null || n === undefined ? '—' : n.toLocaleString(); }
function safe(s){ return String(s||''); }
function parseISOorDateString(s){
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00.000Z');
  return new Date(s);
}

/* --- load data/videos.json --- */
let DATA = [];
let DATA_UPDATED_AT = null;
async function loadData(){
  try{
    const res = await fetch('data/videos.json', {cache: "no-store"});
    if(!res.ok) throw new Error('data/videos.json が見つかりません: ' + res.status);
    const json = await res.json();
    DATA = json.videos || [];
    DATA_UPDATED_AT = json.updated_at || null;
    const lastEl = document.getElementById('lastUpdated');
    if(DATA_UPDATED_AT){
      const d = new Date(DATA_UPDATED_AT);
      lastEl.innerText = '最終更新: ' + d.toLocaleString();
    } else {
      lastEl.innerText = '最終更新: —';
    }

    buildGroupOptions();
    renderRankList();
    selectDefault();
  }catch(err){
    console.error(err);
    document.getElementById('rankList').innerText = 'データ読み込みエラー: ' + err.message;
    const lastEl = document.getElementById('lastUpdated');
    lastEl.innerText = '最終更新: エラー';
  }
}

/* --- UI state and utilities --- */
const rankListEl = document.getElementById('rankList');
const sortModeEl = document.getElementById('sortMode');
const searchEl = document.getElementById('search');
const scopeEl = document.getElementById('scope');
const groupFilterEl = document.getElementById('groupFilter');
const reloadBtn = document.getElementById('reload');

const BANNER_ORDER = [
  "一歌","咲希","穂波","志歩","みのり","遥","愛莉","雫","こはね","杏","彰人","冬弥","司","えむ","寧々","類","奏","まふゆ","絵名","瑞希"
];
const UNIT_ORDER = ["レオニ","モモジャン","ビビバス","ワンダショ","ニーゴ"];

function buildGroupOptions(){
  groupFilterEl.innerHTML = '<option value="all">グループ: 全て</option>';

  if(scopeEl.value === 'banner'){
    BANNER_ORDER.forEach(b => {
      groupFilterEl.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`);
    });
  } else if(scopeEl.value === 'unit'){
    UNIT_ORDER.forEach(u => {
      groupFilterEl.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`);
    });
  } else {
    groupFilterEl.insertAdjacentHTML('beforeend', '<option disabled>--- バナー ---</option>');
    BANNER_ORDER.forEach(b => groupFilterEl.insertAdjacentHTML('beforeend', `<option value="banner:${escapeHtml(b)}">${escapeHtml(b)}</option>`));
    groupFilterEl.insertAdjacentHTML('beforeend', '<option disabled>--- ユニット ---</option>');
    UNIT_ORDER.forEach(u => groupFilterEl.insertAdjacentHTML('beforeend', `<option value="unit:${escapeHtml(u)}">${escapeHtml(u)}</option>`));
  }
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function lastHistoryEntry(history){
  if(!history || history.length===0) return null;
  return history[history.length-1];
}

function findClosestBefore(history, targetDate){
  if(!history || history.length===0) return null;
  let candidate = history[0];
  for(const rec of history){
    const t = rec.datetime ? new Date(rec.datetime) : (rec.date ? new Date(rec.date + 'T00:00:00.000Z') : null);
    if(!t) continue;
    if(t <= targetDate) candidate = rec;
    else break;
  }
  return candidate;
}

function calcDelta(history, days){
  if(!history || history.length===0) return 0;
  const lastRec = lastHistoryEntry(history);
  const lastDate = lastRec ? (lastRec.datetime ? new Date(lastRec.datetime) : (lastRec.date ? new Date(lastRec.date + 'T00:00:00.000Z') : null)) : null;
  if(!lastDate) return 0;
  const startDate = new Date(lastDate);
  startDate.setUTCDate(startDate.getUTCDate() - days);
  const startRec = findClosestBefore(history, startDate) || history[0];
  if(!startRec) return 0;
  const startViews = startRec.views || 0;
  const lastViews = lastRec.views || 0;
  return lastViews - startViews;
}

/* --- render ranking --- */
function renderRankList(){
  const globalAnnotated = DATA.map(v=>{
    const latest = v.history && v.history.length ? (v.history[v.history.length-1].views || 0) : (v.views || 0);
    const d7 = calcDelta(v.history, 7);
    const d30 = calcDelta(v.history, 30);
    return {...v, latest, d7, d30};
  });

  const topWeekGlobal = globalAnnotated.reduce((acc,cur)=> cur.d7 > (acc.d7||-Infinity) ? cur : acc, {});
  const topMonthGlobal = globalAnnotated.reduce((acc,cur)=> cur.d30 > (acc.d30||-Infinity) ? cur : acc, {});
  const topTotalGlobal = globalAnnotated.reduce((acc,cur)=> cur.latest > (acc.latest||-Infinity) ? cur : acc, {});

  document.getElementById('trendWeek').innerText = topWeekGlobal && topWeekGlobal.title ? `${topWeekGlobal.title} — ${fmt(topWeekGlobal.d7)} 回` : '—';
  document.getElementById('trendMonth').innerText = topMonthGlobal && topMonthGlobal.title ? `${topMonthGlobal.title} — ${fmt(topMonthGlobal.d30)} 回` : '—';
  document.getElementById('trendTotal').innerText = topTotalGlobal && topTotalGlobal.title ? `${topTotalGlobal.title} — ${fmt(topTotalGlobal.latest)} 回` : '—';

  const mode = sortModeEl.value;
  const q = searchEl.value.trim().toLowerCase();
  let list = DATA.slice();

  const gv = groupFilterEl.value;
  if(gv && gv !== 'all'){
    if(gv.startsWith('banner:')) list = list.filter(v=>v.banner === gv.slice(7));
    else if(gv.startsWith('unit:')) list = list.filter(v=>v.unit === gv.slice(5));
    else {
      if(scopeEl.value === 'banner') list = list.filter(v=>v.banner === gv);
      if(scopeEl.value === 'unit') list = list.filter(v=>v.unit === gv);
    }
  }

  if(q) list = list.filter(v=>{
    return (v.title||'').toLowerCase().includes(q) || (v.banner||'').toLowerCase().includes(q) || (v.unit||'').toLowerCase().includes(q);
  });

  const annotated = list.map(v=>{
    const latest = v.history && v.history.length ? (v.history[v.history.length-1].views || 0) : (v.views || 0);
    const d7 = calcDelta(v.history, 7);
    const d30 = calcDelta(v.history, 30);
    return {...v, latest, d7, d30};
  });

  if(mode === 'total') annotated.sort((a,b)=>b.latest - a.latest);
  else if(mode === 'week') annotated.sort((a,b)=>b.d7 - a.d7);
  else annotated.sort((a,b)=>b.d30 - a.d30);

  rankListEl.innerHTML = '';
  if(annotated.length === 0){
    rankListEl.innerText = '該当する動画がありません。';
    return;
  }

  annotated.forEach((v, idx)=>{
    const li = document.createElement('div');
    li.className = 'video-item';
    li.innerHTML = `
      <div class="rank-num">${idx+1}</div>
      <img class="thumb" src="${escapeHtml(v.thumbnail)}" alt="thumb">
      <div class="meta">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;">
          <div style="flex:1" class="title">${escapeHtml(v.title)}</div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div class="badge">${escapeHtml(v.banner||'')}</div>
            <div class="badge">${escapeHtml(v.unit||'')}</div>
          </div>
        </div>
        <div class="view-bar">
          <div style="display:flex;flex-direction:column;gap:2px;">
            <div style="font-size:12px;color:var(--muted)">最新再生数</div>
            <div class="count">${fmt(v.latest)} 回</div>
          </div>
          <div style="display:flex;align-items:center;">
            <div class="delta">▲${fmt(v.d7)} / 7d</div>
          </div>
        </div>
      </div>
    `;
    li.addEventListener('click', ()=> selectVideo(v));
    rankListEl.appendChild(li);
  });
}

/* --- chart & selection --- */
let currentSelected = null;
const ctx = document.getElementById('trendChart').getContext('2d');
let chart = null;

function selectVideo(v){
  currentSelected = v;
  document.getElementById('selectedTitle').innerText = v.title;
  document.getElementById('selectedMeta').innerHTML = `${v.banner} ・ ${v.unit} ・ <a href="${v.url}" target="_blank" style="color:var(--accent)">YouTubeへ</a>`;
  const lastRec = v.history && v.history.length ? v.history[v.history.length-1] : null;
  const lastViews = lastRec ? lastRec.views : (v.views || 0);
  document.getElementById('selectedViews').innerText = fmt(lastViews) + ' 回';
  document.getElementById('viewDelta7').innerText = fmt(calcDelta(v.history,7)) + ' 回';
  document.getElementById('viewDelta30').innerText = fmt(calcDelta(v.history,30)) + ' 回';
  document.getElementById('publishDate').innerText = v.published || '—';
  drawChartForSelection('all');
}

function drawChartForSelection(period){
  if(!currentSelected) return;
  const hist = currentSelected.history || [];
  if(hist.length === 0) {
    if(chart){ chart.destroy(); chart = null; }
    ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
    return;
  }
  const pts = hist.map(h => {
    const ts = h.datetime ? new Date(h.datetime) : (h.date ? new Date(h.date + 'T00:00:00.000Z') : null);
    return ts ? { t: ts, v: (h.views || 0) } : null;
  }).filter(Boolean);

  let points = pts.slice();
  if(period === '7') {
    const cutoff = new Date(points[points.length-1].t);
    cutoff.setUTCDate(cutoff.getUTCDate() - 7);
    points = points.filter(p => p.t >= cutoff);
  } else if(period === '30') {
    const cutoff = new Date(points[points.length-1].t);
    cutoff.setUTCDate(cutoff.getUTCDate() - 30);
    points = points.filter(p => p.t >= cutoff);
  }

  const labels = points.map(p => {
    const d = p.t;
    return d.toLocaleString();
  });
  const data = points.map(p => p.v);

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: currentSelected.title, data, tension:0.2, fill:true, backgroundColor: 'rgba(37,99,235,0.06)', borderColor:'rgba(37,99,235,0.9)', pointRadius:2 }]},
    options: {
      responsive:true, maintainAspectRatio:false,
      scales: {
        x: {
          display:true,
          grid:{color:'rgba(15,23,42,0.03)'},
          ticks:{ color:'#6b7c93', font: { size: 11 } }
        },
        y: {
          display:true,
          grid:{color:'rgba(15,23,42,0.03)'},
          ticks:{ color:'#6b7c93', callback: v => Intl.NumberFormat().format(v), font: { size: 11 } }
        }
      },
      plugins: {
        legend:{display:false},
        tooltip:{ callbacks: { label: ctx => `${Intl.NumberFormat().format(ctx.parsed.y)} 回` } }
      }
    }
  });
}

/* --- event binding --- */
document.getElementById('reload').addEventListener('click', loadData);
sortModeEl.addEventListener('change', renderRankList);
searchEl.addEventListener('input', renderRankList);
scopeEl.addEventListener('change', ()=>{ buildGroupOptions(); renderRankList(); });
groupFilterEl.addEventListener('change', renderRankList);

const btnAll = document.getElementById('btnAll');
if(btnAll) btnAll.addEventListener('click', ()=> { scopeEl.value='all'; buildGroupOptions(); renderRankList(); });
const btnBanner = document.getElementById('btnBanner');
if(btnBanner) btnBanner.addEventListener('click', ()=> { scopeEl.value='banner'; buildGroupOptions(); renderRankList(); });
const btnUnit = document.getElementById('btnUnit');
if(btnUnit) btnUnit.addEventListener('click', ()=> { scopeEl.value='unit'; buildGroupOptions(); renderRankList(); });

document.querySelectorAll('.tab-mode').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-mode').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    drawChartForSelection(btn.dataset.period);
  });
});

/* --- default select --- */
function selectDefault(){
  if(DATA.length) {
    const sorted = DATA.slice().sort((a,b)=> {
      const la = a.history && a.history.length ? a.history[a.history.length-1].views : (a.views||0);
      const lb = b.history && b.history.length ? b.history[b.history.length-1].views : (b.views||0);
      return lb - la;
    });
    selectVideo(sorted[0]);
  }
}

/* --- initial load --- */
loadData();
</script>
</body>
</html>
